from machine import Pin, SoftI2C, Timer
import ssd1306
import time

# ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –î–ò–°–ü–õ–ï–Ø =====
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è I2C –¥–ª—è –¥–∏—Å–ø–ª–µ—è SSD1306
# SoftI2C - –ø—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è I2C –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
# scl=Pin(47) - –ø–∏–Ω –¥–ª—è —Ç–∞–∫—Ç–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ (Serial Clock)
# sda=Pin(21) - –ø–∏–Ω –¥–ª—è –¥–∞–Ω–Ω—ã—Ö (Serial Data)
i2c = SoftI2C(scl=Pin(47), sda=Pin(21))

# –†–∞–∑–º–µ—Ä—ã –¥–∏—Å–ø–ª–µ—è –≤ –ø–∏–∫—Å–µ–ª—è—Ö
W = 128  # –®–∏—Ä–∏–Ω–∞
H = 64   # –í—ã—Å–æ—Ç–∞

# –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –¥–∏—Å–ø–ª–µ—è
# SSD1306_I2C() - –¥—Ä–∞–π–≤–µ—Ä –¥–ª—è OLED –¥–∏—Å–ø–ª–µ—è —Å I2C –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
oled = ssd1306.SSD1306_I2C(W, H, i2c)

# ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ú–ê–¢–†–ò–ß–ù–û–ô –ö–õ–ê–í–ò–ê–¢–£–†–´ 4x6 =====
# –°—Ç—Ä–æ–∫–∏ (–≤—ã—Ö–æ–¥—ã) - –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–æ–¥–∞–µ—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–æ–∫–∏
rows = [
    Pin(1, Pin.OUT),   # –°—Ç—Ä–æ–∫–∞ 0
    Pin(2, Pin.OUT),   # –°—Ç—Ä–æ–∫–∞ 1  
    Pin(3, Pin.OUT),   # –°—Ç—Ä–æ–∫–∞ 2
    Pin(4, Pin.OUT)    # –°—Ç—Ä–æ–∫–∞ 3
]

# –°—Ç–æ–ª–±—Ü—ã (–≤—Ö–æ–¥—ã) - –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —á–∏—Ç–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤
# Pin.PULL_DOWN - –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø–æ–¥—Ç—è–∂–∫–∞ –∫ –∑–µ–º–ª–µ (0V)
cols = [
    Pin(5, Pin.IN, Pin.PULL_DOWN),  # –°—Ç–æ–ª–±–µ—Ü 0
    Pin(6, Pin.IN, Pin.PULL_DOWN),  # –°—Ç–æ–ª–±–µ—Ü 1
    Pin(7, Pin.IN, Pin.PULL_DOWN),  # –°—Ç–æ–ª–±–µ—Ü 2
    Pin(8, Pin.IN, Pin.PULL_DOWN),  # –°—Ç–æ–ª–±–µ—Ü 3
    Pin(9, Pin.IN, Pin.PULL_DOWN),  # –°—Ç–æ–ª–±–µ—Ü 4
    Pin(10, Pin.IN, Pin.PULL_DOWN)  # –°—Ç–æ–ª–±–µ—Ü 5
]

# ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–´–• –ö–ù–û–ü–û–ö =====
# Pin.PULL_UP - –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø–æ–¥—Ç—è–∂–∫–∞ –∫ –ø–∏—Ç–∞–Ω–∏—é (3.3V)
# –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –ø–∏–Ω –∑–∞–º—ã–∫–∞–µ—Ç—Å—è –Ω–∞ –∑–µ–º–ª—é (–∑–Ω–∞—á–µ–Ω–∏–µ 0)
nav_buttons = {
    'up': Pin(11, Pin.IN, Pin.PULL_UP),
    'down': Pin(12, Pin.IN, Pin.PULL_UP), 
    'left': Pin(13, Pin.IN, Pin.PULL_UP),
    'right': Pin(14, Pin.IN, Pin.PULL_UP),
    'enter': Pin(15, Pin.IN, Pin.PULL_UP)
}

# ===== –ö–ê–†–¢–ê –°–ò–ú–í–û–õ–û–í –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–ê =====
# –ú–∞—Ç—Ä–∏—Ü–∞ 4x6 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—é –∫–Ω–æ–ø–æ–∫
keymap = [
    ['7', '8', '9', '/', 'C', 'AC'],    # –°—Ç—Ä–æ–∫–∞ 0
    ['4', '5', '6', '*', '(', ')'],     # –°—Ç—Ä–æ–∫–∞ 1
    ['1', '2', '3', '-', '=', 'ANS'],   # –°—Ç—Ä–æ–∫–∞ 2  
    ['0', '.', '%', '+', '^', 'MOD']    # –°—Ç—Ä–æ–∫–∞ 3
]

# ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–û–°–¢–û–Ø–ù–ò–ï–ú =====
stable_matrix_keys = []    # –¢–µ–∫—É—â–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∞–∂–∞—Ç—ã–µ –º–∞—Ç—Ä–∏—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
stable_nav_keys = []       # –¢–µ–∫—É—â–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∞–∂–∞—Ç—ã–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
last_matrix_keys = []      # –ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ç—Ä–∏—á–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ (–¥–ª—è –∞–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥–∞)
last_nav_keys = []         # –ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ (–¥–ª—è –∞–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥–∞)
pressed_keys_history = set()  # –ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∂–∞—Ç—ã—Ö –º–∞—Ç—Ä–∏—á–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ (–¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π)
pressed_nav_history = set()   # –ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∂–∞—Ç—ã—Ö –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ (–¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π)
is_scanning = False        # –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –≤ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

# ===== –§–£–ù–ö–¶–ò–Ø –¶–ï–ù–¢–†–ò–†–û–í–ê–ù–ò–Ø –¢–ï–ö–°–¢–ê =====
def center_text(text, y):
    """–í—ã–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–π Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ"""
    x = (W - len(text) * 8) // 2  # –†–∞—Å—á–µ—Ç X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (8 –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ —Å–∏–º–≤–æ–ª)
    if x < 0:  # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π - –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é
        x = 0
    oled.text(text, x, y)  # –í—ã–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –¥–∏—Å–ø–ª–µ–π

# ===== –≠–§–§–ï–ö–¢–ò–í–ù–û–ï –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï –ú–ê–¢–†–ò–ß–ù–û–ô –ö–õ–ê–í–ò–ê–¢–£–†–´ =====
def fast_scan_matrix():
    """
    –ë—ã—Å—Ç—Ä–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç—Ä–∏—á–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã 4x6
    –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã: 
    1. –ü–æ–æ—á–µ—Ä–µ–¥–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É (–ø–æ–¥–∞–µ–º HIGH)
    2. –ß–∏—Ç–∞–µ–º –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã –≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
    3. –ï—Å–ª–∏ —Å—Ç–æ–ª–±–µ—Ü –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç HIGH - –∫–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞
    4. –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π
    """
    pressed_keys = []  # –°–ø–∏—Å–æ–∫ –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –Ω–∞–∂–∞—Ç—ã—Ö –∫–Ω–æ–ø–æ–∫
    
    for row_num, row_pin in enumerate(rows):  # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ 4 —Å—Ç—Ä–æ–∫–∏
        row_pin.value(1)  # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É (–ø–æ–¥–∞–µ–º 3.3V)
        
        # –ß–∏—Ç–∞–µ–º –≤—Å–µ 6 —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
        for col_num, col_pin in enumerate(cols):
            if col_pin.value() == 1:  # –ï—Å–ª–∏ –≤ —Å—Ç–æ–ª–±—Ü–µ HIGH - –∫–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞
                # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä—Ç–µ–∂: (–Ω–æ–º–µ—Ä_—Å—Ç—Ä–æ–∫–∏, –Ω–æ–º–µ—Ä_—Å—Ç–æ–ª–±—Ü–∞, —Å–∏–º–≤–æ–ª_–∫–Ω–æ–ø–∫–∏)
                pressed_keys.append((row_num, col_num, keymap[row_num][col_num]))
        
        row_pin.value(0)  # –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É (–ø–æ–¥–∞–µ–º 0V)
    
    return pressed_keys

# ===== –≠–§–§–ï–ö–¢–ò–í–ù–û–ï –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–´–• –ö–ù–û–ü–û–ö =====
def fast_scan_nav():
    """
    –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ 5 –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
    - –ö–Ω–æ–ø–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã —Å –ø–æ–¥—Ç—è–∂–∫–æ–π –∫ –ø–∏—Ç–∞–Ω–∏—é (PULL_UP)
    - –í –Ω–µ–Ω–∞–∂–∞—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏: –∑–Ω–∞—á–µ–Ω–∏–µ = 1 (3.3V)
    - –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏: –∑–Ω–∞—á–µ–Ω–∏–µ = 0 (–∑–∞–º—ã–∫–∞–Ω–∏–µ –Ω–∞ –∑–µ–º–ª—é)
    """
    pressed_nav = []  # –°–ø–∏—Å–æ–∫ –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –Ω–∞–∂–∞—Ç—ã—Ö –∫–Ω–æ–ø–æ–∫
    
    for name, button in nav_buttons.items():  # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        if button.value() == 0:  # –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞ (–∑–Ω–∞—á–µ–Ω–∏–µ 0)
            pressed_nav.append(name)  # –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –∫–Ω–æ–ø–∫–∏ –≤ —Å–ø–∏—Å–æ–∫
    
    return pressed_nav

# ===== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –î–†–ï–ë–ï–ó–ì–ê –ö–û–ù–¢–ê–ö–¢–û–í =====
def debounce_keys(current_matrix, current_nav):
    """
    –ê–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º
    –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –º–µ–Ω—è–ª–æ—Å—å
    """
    global last_matrix_keys, last_nav_keys, stable_matrix_keys, stable_nav_keys
    
    # –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º - —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ
    if current_matrix == last_matrix_keys and current_nav == last_nav_keys:
        stable_matrix_keys = current_matrix  # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –º–∞—Ç—Ä–∏—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        stable_nav_keys = current_nav        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    last_matrix_keys = current_matrix
    last_nav_keys = current_nav

# ===== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô –ö–ù–û–ü–û–ö =====
def handle_key_events():
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –Ω–∞–∂–∞—Ç–∏—è –∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫
    –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –∏—Å—Ç–æ—Ä–∏–µ–π —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å:
    - –ù–æ–≤—ã–µ –Ω–∞–∂–∞—Ç–∏—è (–∫–Ω–æ–ø–∫–∏ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏)
    - –û—Ç–ø—É—â–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (–∫–Ω–æ–ø–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–æ —Å–µ–π—á–∞—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)
    """
    global pressed_keys_history, pressed_nav_history
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞–∂–∞—Ç—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    current_keys = set([key for _, _, key in stable_matrix_keys])  # –¢–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã –º–∞—Ç—Ä–∏—á–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    current_nav = set(stable_nav_keys)  # –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    
    # –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–µ –Ω–∞–∂–∞—Ç–∏—è (–∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å —Å–µ–π—á–∞—Å, –Ω–æ –Ω–µ –±—ã–ª–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏)
    new_key_presses = current_keys - pressed_keys_history
    new_nav_presses = current_nav - pressed_nav_history
    
    # –ù–∞—Ö–æ–¥–∏–º –æ—Ç–ø—É—â–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (–∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏, –Ω–æ —Å–µ–π—á–∞—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)
    released_keys = pressed_keys_history - current_keys
    released_nav = pressed_nav_history - current_nav
    
    # ===== –û–ë–†–ê–ë–û–¢–ö–ê –ù–û–í–´–• –ù–ê–ñ–ê–¢–ò–ô =====
    for key in new_key_presses:
        print(f"‚ñ∂ –ù–ê–ñ–ê–¢–ê: {key}")
        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    
    for nav in new_nav_presses:
        print(f"‚ñ∂ –ù–ê–í–ò–ì–ê–¶–ò–Ø: {nav}")
        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    
    # ===== –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–ü–£–©–ï–ù–ù–´–• –ö–ù–û–ü–û–ö =====
    for key in released_keys:
        print(f"‚óÄ –û–¢–ü–£–©–ï–ù–ê: {key}")
    
    for nav in released_nav:
        print(f"‚óÄ –ù–ê–í–ò–ì–ê–¶–ò–Ø –û–¢–ü–£–©–ï–ù–ê: {nav}")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç–µ–∫—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
    pressed_keys_history = current_keys
    pressed_nav_history = current_nav

# ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ò–°–ü–õ–ï–Ø =====
def update_display():
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ –¥–∏—Å–ø–ª–µ–µ"""
    oled.fill(0)  # –û—á–∏—â–∞–µ–º –¥–∏—Å–ø–ª–µ–π (–∑–∞–ø–æ–ª–Ω—è–µ–º —á–µ—Ä–Ω—ã–º)
    
    # –í—ã–≤–æ–¥–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    center_text("CALCULATOR", 0)
    
    # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∞–∂–∞—Ç—ã–µ –º–∞—Ç—Ä–∏—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    oled.text("Buttons:", 0, 15)
    for i, (row, col, key) in enumerate(stable_matrix_keys[:4]):  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ 4 –∫–Ω–æ–ø–æ–∫
        oled.text(f"{key}({row},{col})", 0, 25 + i * 10)
    
    # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∞–∂–∞—Ç—ã–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    oled.text("Navigation:", 0, 45)
    nav_text = ",".join(stable_nav_keys) if stable_nav_keys else "None"
    oled.text(nav_text, 0, 55)
    
    oled.show()  # –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –¥–∏—Å–ø–ª–µ–π

# ===== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø =====
def scan_all(timer):
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –≤—ã–∑—ã–≤–∞–µ–º–∞—è —Ç–∞–π–º–µ—Ä–æ–º –∫–∞–∂–¥—ã–µ 20ms
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ —ç—Ç–∞–ø—ã: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏—Å–ø–ª–µ—è
    """
    global is_scanning
    
    if is_scanning:  # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ (reentrancy protection)
        return
    
    is_scanning = True  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    
    try:
        # 1. –ë—ã—Å—Ç—Ä–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–µ–∏—Ö –∫–ª–∞–≤–∏–∞—Ç—É—Ä
        current_matrix = fast_scan_matrix()
        current_nav = fast_scan_nav()
        
        # 2. –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        debounce_keys(current_matrix, current_nav)
        
        # 3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞–∂–∞—Ç–∏—è/–æ—Ç–ø—É—Å–∫–∞–Ω–∏—è
        handle_key_events()
        
        # 4. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏—Å–ø–ª–µ–π (–º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —Ä–µ–∂–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
        update_display()
        
    finally:
        is_scanning = False  # –°–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

# ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –¢–ê–ô–ú–ï–†–ê =====
def init_keyboard_timer():
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    Timer(0) - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞ 0
    period=20 - –≤—ã–∑–æ–≤ –∫–∞–∂–¥—ã–µ 20 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ (50 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)
    mode=Timer.PERIODIC - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º (–ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)
    callback=scan_all - —Ñ—É–Ω–∫—Ü–∏—è –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø–æ —Ç–∞–π–º–µ—Ä—É
    """
    keyboard_timer = Timer(0)
    keyboard_timer.init(period=20, mode=Timer.PERIODIC, callback=scan_all)
    return keyboard_timer

# ===== –û–°–ù–û–í–ù–ê–Ø –ü–†–û–ì–†–ê–ú–ú–ê =====
def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã"""
    print("üöÄ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ESP32 - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º —Å —Ç–∞–π–º–µ—Ä–æ–º")
    print("–ù–∞–∂–∏–º–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –æ–ø—Ä–æ—Å–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    init_keyboard_timer()
    
    # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç–µ–ø–µ—Ä—å –ø–æ—á—Ç–∏ –ø—É—Å—Ç–æ–π
    # –í—Å—è —Ä–∞–±–æ—Ç–∞ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ñ–æ–Ω–µ –ø–æ —Ç–∞–π–º–µ—Ä—É
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    while True:
        # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã –±—É–¥–µ—Ç –∑–¥–µ—Å—å
        # –ù–∞–ø—Ä–∏–º–µ—Ä: –≤—ã—á–∏—Å–ª–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, —Ä–∞–±–æ—Ç–∞ —Å –º–µ–Ω—é
        time.sleep(1)  # –°–ø–∏–º 1 —Å–µ–∫—É–Ω–¥—É - –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Å–≤–æ–±–æ–¥–µ–Ω –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á

# ===== –ó–ê–ü–£–°–ö –ü–†–û–ì–†–ê–ú–ú–´ =====
if __name__ == "__main__":
    main()